# MUIP-0001: Basic Protocol Flow Definition

This MUIP defines the basic protocol that should be implemented by all Mugraph nodes. It does not define on-chain communication or implementation, as these can be implemented in multiple different ways.

## Transport

Mugraph is a protocol running on top of TCP, on a request-based, client-to-server configuration. A Mugraph server (by default) must listen for requests on two ports:

- `11983`, for direct TCP communications from users.
- `11999`, for encrypted communications with TLS.

Servers should never connect directly to the users, and no NAT/uPnP provisions need to be done. Connections between clients and servers must be able to be kept open for subscriptions.

Servers should also support WebSockets connections, on the port `11080` and `11443` (for WS and WSS, respectively). The wire communication should be the same, and just proxying from WebSockets into a normal TCP connection must always be considered perfectly reasonable.

## Serialization

Mugraph uses [CBOR](https://cbor.io/) as the wire format.

CBOR support the same data types as JSON, but most JSON implementations do not define deterministic rules for ordering, so nodes must implement a deterministic field/value ordering based on the following:

| JSON Value Type | Expected Mugraph Ordering |
|-------------------|------------------------------------|
| Null | Equal to other nulls; compared before other types |
| Boolean (`true`) | `false < true`; compared after `null` |
| Number | Ordered numerically, both integers and floats are compared directly |
| String | Ordered lexicographically |
| Array | Compared element-wise; based on length and then lexicographically |
| Object | Compared lexicographically by key names, then by corresponding values |

### Additional Notes

1. Nodes must use the same deterministic ordering comparision that `serde_json::Value` implements (`Null` < `Boolean` < `Number` < `String` < `Array` < `Object`).
2. **Arrays** in requests must be considered as equivalent to **Sets**, and be consumed/iterated with their elements sorted following the mentioned rules.

## Notes and Wallets

Users in the Mugraph network have at least one wallet, usually at least a few. The Wallet internals are not standardized by this MUIP, but it is just a data container for **Notes**.

A Note has the following schema:

```proto
message Note {
    /// The Hydra Head where the funds are contained
    bytes head_id = 0;
    // The transaction ID that generated this Note
    bytes txid = 1;
    // The output index for this Note 
    uint8 index = 2;
    // The necessary key to spend this Note
    bytes key = 3;
}
```

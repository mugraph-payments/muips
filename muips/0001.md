# MUIP-0001: Basic Protocol Flow Definition

This MUIP defines the basic protocol that should be implemented by all Mugraph nodes. It does not define on-chain communication or implementation, as these can be implemented in multiple different ways.

## Protocol

Mugraph runs on top of TCP on a request-based, client-to-server configuration. A server (by default) must listen for requests on the following ports:

| Port   | Protocol  | Description |
|--------|-----------|-------------|
| 11983  | TCP       | Direct TCP communications from users |
| 11999  | TCP + TLS | Encrypted communications |
| 11080  | WS        | WebSocket connections |
| 11443  | WSS       | Secure WebSocket connections |

Servers should never connect directly to the users, and no NAT/uPnP provisions need to be done. Connections between clients and servers must be able to be kept open for subscriptions.

The wire communication should be the same for all protocols, and just proxying from WebSockets into a normal TCP connection must always be considered perfectly reasonable.

### Serialization

Mugraph uses [CBOR](https://cbor.io/) as the wire format.

CBOR support the same data types as JSON, but most JSON implementations do not define deterministic rules for ordering, so nodes must implement a deterministic field/value ordering based on the following:

| JSON Value Type | Expected Mugraph Ordering |
|-------------------|------------------------------------|
| Null | Equal to other nulls; compared before other types |
| Boolean (`true`) | `false < true`; compared after `null` |
| Number | Ordered numerically, both integers and floats are compared directly |
| String | Ordered lexicographically |
| Array | Compared element-wise; based on length and then lexicographically |
| Object | Compared lexicographically by key names, then by corresponding values |

#### Additional Notes

1. Nodes must use the same deterministic ordering comparision that `serde_json::Value` implements (`Null` < `Boolean` < `Number` < `String` < `Array` < `Object`).
2. **Arrays** in requests must be considered as equivalent to **Sets**, and be consumed/iterated with their elements sorted following the mentioned rules.

## RPC Calls

### Requests
Clients requests to servers are wrapped in **RPC Calls**, following this schema:

```json
{
    "method": "dev.mugraph.v1.transfer",
    "arguments": {
        "hello": "world"
    },
    "signatures": [
        "ad4e..."
    ]
}
```

### Responses

- [ ] Normal
- [ ] Errors
    - [ ] Double Spend
    - [ ] Application Error


## Resources

### Notes

A Note has the following schema:

```json
{
    "host": "mugraph.dev:11983",
    "headId": "37fffa4675e2dee81cf65cfff99bdf75662e8e50c35f54724abc37638aa6295b",
    "txId": "9c435473d09770681b8e7fef4fdf5633befc39152b05e32ff68c9faa9aeaaf1d",
    "program": {
        "runner": "dev.mugraph.risc0",
        "id": "02840ce8a77689d09723706bb2808d31beb8151d08f96e2c739269746e73efef",
        "datum": {
            "hello": "World"
        }
    },
    "signature": "02840ce8a77689d09723706bb2808d31beb8151d08f96e2c739269746e73efef5369a05b9ddd40862d74cefcd5cdf1e909afde6ab153dd89acd85e014f062167",
}
```

With the following definitions:

| Field | Description |
|-------|-------------|
| `host` | The address and port of the Mugraph node hosting this note |
| `headId` | The unique identifier of the hydra head associated with this note |
| `txId` | The unique identifier of the transaction that created this note |
| `program` | An object containing information about the program associated with this note |
| `program.runner` | The identifier of the program runner (e.g., RISC-0) |
| `program.id` | The unique identifier of the program |
| `program.datum` | Additional data associated with the program execution |
| `signature` | A cryptographic signature to ensure the integrity and authenticity of the note |

## Notes

1. While protocol transport is CBOR, examples are given in JSON. This is a readability decision, as a binary formatwould not be user-readable.
